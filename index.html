<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sorpresa - Mi Esposita</title>
  <style>
    :root{
      --card-bg: rgba(0,0,0,0.66);
      --muted: #cbd5e1;
      --accent: #f59e0b;
      --danger: #ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;background:#071126;color:#e6eef8}
    .stage{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      position:relative;
      overflow:hidden;
    }

    /* fondo del regalo (cubrir pantalla) */
    #gift-bg {
      position: fixed;
      inset: 0;
      background-size: cover;
      background-position: center;
      filter: blur(25px);
      transition: filter 5s ease-out, opacity 1s ease-in;
      opacity: 0;
      z-index:1;
    }
    #gift-bg.reveal{filter: blur(0); opacity: 1;}

    .card {
      width:100%;
      max-width:780px;
      padding:22px;
      border-radius:14px;
      background: linear-gradient(180deg, rgba(0,0,0,0.60), rgba(0,0,0,0.70));
      box-shadow: 0 10px 40px rgba(2,6,23,0.7);
      position:relative;
      z-index:2;
    }
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    header h1{font-size:20px;margin:0}
    header p.small{margin:0;color:var(--muted);font-size:13px}

    .lives{font-size:18px}
    .story{margin-top:18px;font-size:16px;line-height:1.45;color:#e6eef8}
    .options{display:flex;flex-direction:column;gap:12px;margin-top:18px}
    .opt{
      background:transparent;
      border:2px solid rgba(255,255,255,0.06);
      padding:12px 14px;
      border-radius:10px;
      text-align:left;
      color:#e6eef8;
      font-weight:700;
      cursor:pointer;
      transition:transform .12s ease, border-color .12s;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .opt:hover{transform:translateY(-3px);border-color:var(--accent)}
    .opt span.emoji{font-size:20px}
    .footer{margin-top:18px;color:var(--muted);font-size:13px}

    /* modal fallo / reinicio */
    .modal {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%);
      min-width:260px;
      max-width:90%;
      background: rgba(2,6,23,0.95);
      border-radius:12px;
      padding:18px;
      box-shadow: 0 8px 30px rgba(2,6,23,0.8);
      z-index:999;
      display:none;
    }
    .modal.show{display:block}
    .modal h3{margin:0 0 8px}
    .modal p{margin:0 0 12px;color:var(--muted)}
    .btn {padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--accent);color:#081126}
    .btn.ghost{background:transparent;border:2px solid rgba(255,255,255,0.06);color:#e6eef8}

    /* confetti canvas full screen */
    canvas.confetti{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:999}

    /* texto final grande */
    .final-title{font-size:24px;margin:8px 0}
    @media (max-width:520px){
      header h1{font-size:18px}
      .story{font-size:15px}
      .final-title{font-size:20px}
    }
  </style>
</head>
<body>
  <div id="gift-bg" aria-hidden="true"></div>

  <main class="stage" role="main">
    <section class="card" aria-live="polite">
      <header>
        <div>
          <h1>¬°Feliz cumplea√±os, <span id="name">Mi Esposita</span>! üéâ</h1>
          <p class="small">Elige sabiamente ‚Äî algunas elecciones son trampas encantadoras.</p>
        </div>
        <div class="lives" aria-hidden="false">Vidas: <span id="hearts">‚ù§Ô∏è‚ù§Ô∏è</span></div>
      </header>

      <article class="story" id="story">Cargando aventura‚Ä¶</article>

      <div class="options" id="options" role="list"></div>

      <div class="footer">No hay pistas. S√≥lo coraje y caprichos. üòâ</div>
    </section>
  </main>

  <!-- modal para finales / reinicios -->
  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <h3 id="modal-title">Oh no...</h3>
    <p id="modal-msg">Mensaje</p>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn ghost" id="modal-retry">Reintentar</button>
    </div>
  </div>

  <!-- canvas confetti -->
  <canvas id="cconf" class="confetti" aria-hidden="true"></canvas>

  <script>
    /***************************
     * Recursos de audio (libres)
     * He usado enlaces p√∫blicos de Pixabay como ejemplos.
     * Nota: en navegadores, la reproducci√≥n con sonido requiere interacci√≥n del usuario.
     ***************************/
    const AUDIO = {
      mystery: new Audio('https://cdn.pixabay.com/download/audio/2021/10/07/audio_5c6f0a6b4a.mp3?filename=dramatic-ambient-112525.mp3'), // loop
      fail: new Audio('https://cdn.pixabay.com/download/audio/2022/03/15/audio_6c1a4f7f1e.mp3?filename=incorrect-18966.mp3'), // fail beep
      success: new Audio('https://cdn.pixabay.com/download/audio/2021/12/11/audio_87f53d3f96.mp3?filename=tada-1-6296.mp3') // success
    };
    AUDIO.mystery.loop = true;

    // Background image (Unsplash atardecer pir√°mides - URL con par√°metros)
    const GIFT_IMAGE_URL = 'https://images.unsplash.com/photo-1613932534449-3d1cc403a53a?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80';

    /***************************
     * Juego: nodos, estado y l√≥gica
     ***************************/
    const NODES = {
      start: {
        text: `Mi Esposita üíñ, hoy empieza tu aventura de cumplea√±os. Cada decisi√≥n te acerca (o te aleja) de tu verdadero regalo. ¬øLista?`,
        options: [
          { emoji: 'üé∂', text: 'Un concierto √≠ntimo', next: 'node1', correct: true },
          { emoji: 'üç´', text: 'Una caja gigante de bombones', next: 'fail_chocolate', correct: false }
        ]
      },
      fail_chocolate: {
        text: `Los bombones eran tan deliciosos que te quedaste dormida con una sonrisa. üò¥üç´`,
        fail: true
      },

      node1: {
        text: `Llegas a un escenario m√°gico: a tu izquierda hay mimo y calma, a la derecha algo que te eleva. ¬øCu√°l eliges?`,
        options: [
          { emoji: 'üíÜ', text: 'Masaje de lujo', next: 'fail_masaje', correct: false },
          { emoji: 'üéà', text: 'Paseo en globo', next: 'node2', correct: true }
        ]
      },
      fail_masaje: {
        text: `El masaje fue tan perfecto que te convertiste en estatua de gelatina. üíÜ‚Äç‚ôÄÔ∏èü§£ ¬°Inm√≥vil de felicidad!`,
        fail: true
      },

      node2: {
        text: `El globo te deja en un bazar misterioso. Dos cajas: una perfuma el aire, la otra susurra secretos. ¬øCu√°l abres?`,
        options: [
          { emoji: 'üß¥', text: 'Perfume √°rabe', next: 'fail_perfume', correct: false },
          { emoji: '‚úâÔ∏è', text: 'Un sobre misterioso', next: 'node3', correct: true }
        ]
      },
      fail_perfume: {
        text: `El perfume era tan potente que hasta los camellos se pusieron las patas en la oreja. üê™üí®`,
        fail: true
      },

      node3: {
        text: `Dentro del sobre hay dos experiencias extremas. Escoge con valent√≠a.`,
        options: [
          { emoji: 'ü™Ç', text: 'Saltarte en paraca√≠das', next: 'fail_paracaidas', correct: false },
          { emoji: 'ü¶Å', text: 'Safari en jeep', next: 'node4', correct: true }
        ]
      },
      fail_paracaidas: {
        text: `Saltaste en paraca√≠das, pero el instructor te entreg√≥ un paraguas en su lugar. ‚òÇÔ∏èüò±`,
        fail: true
      },

      node4: {
        text: `El safari llega a un cruce: objetos tentadores aparecen. ¬øQu√© eliges?`,
        options: [
          { emoji: 'üé§', text: 'Micr√≥fono para crear contenido', next: 'fail_micro', correct: false },
          { emoji: '‚úàÔ∏è', text: 'Tomar un avi√≥n privado', next: 'success', correct: true }
        ]
      },
      fail_micro: {
        text: `Usaste el micr√≥fono y ahora un gallo es tu compa√±ero de d√∫o. üêìüé§ Fuiste viral, pero no encontraste el regalo.`,
        fail: true
      },

      success: {
        text: `¬°Lo lograste! El avi√≥n privado despega y el destino aparece en la pantalla: üåÖ **EGIPTO** üåÖ\n\nMi Esposita, tu regalo es un viaje a las pir√°mides. ‚ú®üéÅ`,
        success: true
      }
    };

    // Estado del juego
    let state = {
      current: 'start',
      lives: 2,
      startedSound: false
    };

    // Elementos DOM
    const storyEl = document.getElementById('story');
    const optionsEl = document.getElementById('options');
    const heartsEl = document.getElementById('hearts');
    const giftBg = document.getElementById('gift-bg');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMsg = document.getElementById('modal-msg');
    const modalRetry = document.getElementById('modal-retry');
    const confCanvas = document.getElementById('cconf');

    // iniciar render
    function renderNode(key){
      state.current = key;
      const node = NODES[key];
      // update story
      storyEl.textContent = node.text;
      // clear options
      optionsEl.innerHTML = '';
      // if node has options
      if(node.options && node.options.length){
        node.options.forEach(opt => {
          const b = document.createElement('button');
          b.className = 'opt';
          b.setAttribute('role','button');
          b.innerHTML = `<span class="emoji">${opt.emoji}</span><span>${opt.text}</span>`;
          b.addEventListener('click', () => onChoose(opt));
          optionsEl.appendChild(b);
        });
      } else {
        // no options = terminal node (fail or success)
        if(node.fail){
          // handle fail node as losing one life
          handleFail(node.text);
        } else if(node.success){
          handleSuccess(node.text);
        }
      }
    }

    // when an option is chosen
    function onChoose(opt){
      // start music on first interaction
      if(!state.startedSound){
        try { AUDIO.mystery.play().catch(()=>{}); } catch(e) {}
        state.startedSound = true;
      }
      // proceed to node
      const next = opt.next;
      // if option is marked correct or not, we still follow flow: incorrect nodes are designated fail nodes
      renderNode(next);
    }

    // handle failure nodes: reduce life, play fail sound, show modal with message and retry button
    function handleFail(text){
      // play fail sound
      try { AUDIO.fail.currentTime = 0; AUDIO.fail.play().catch(()=>{}); } catch(e){}
      state.lives = Math.max(0, state.lives - 1);
      updateLives();

      const msg = text + (state.lives > 0 ? `\n\nTe quedan ${state.lives} vida(s).` : `\n\nYa no te quedan vidas.`);
      showModal('¬°Vaya! üòÖ', msg, () => {
        // if still has lives, just return to start OR allow retry?
        if(state.lives > 0){
          // let player decide to retry same start or restart whole? Per spec, show reinicio button ‚Äî we will let them restart from start.
          closeModal();
          // go to start (as per spec: when choose a bad path they lose and must restart)
          resetToStart();
        } else {
          // no lives: reset lives and restart
          closeModal();
          resetGameFull();
        }
      });
    }

    // handle success node
    function handleSuccess(text){
      // stop mystery music and play success music
      try { AUDIO.mystery.pause(); AUDIO.success.currentTime = 0; AUDIO.success.play().catch(()=>{}); } catch(e){}
      // show final story text bigger
      storyEl.innerHTML = `<div class="final-title">¬°Destino desbloqueado!</div><div style="white-space:pre-line">${text}</div>`;
      optionsEl.innerHTML = '';
      // reveal background (image) and confetti
      giftBg.style.backgroundImage = `url('${GIFT_IMAGE_URL}')`;
      setTimeout(()=> {
        giftBg.classList.add('reveal');
        // reveal the final message card (fade) - we already set story
        startConfetti();
      }, 120);
      // also show a single button to "volver a jugar" beneath
      const btn = document.createElement('button');
      btn.className = 'opt';
      btn.innerHTML = `<span class="emoji">üîÅ</span><span>Jugar de nuevo</span>`;
      btn.addEventListener('click', () => {
        // stop confetti and success sound, restart music
        stopConfetti();
        resetGameFull();
      });
      optionsEl.appendChild(btn);
    }

    // update hearts UI
    function updateLives(){
      const hearts = '‚ù§Ô∏è'.repeat(state.lives) + (state.lives < 2 ? 'ü§ç'.repeat(2 - state.lives) : '');
      heartsEl.textContent = hearts;
    }

    // reset to start (keep remaining lives)
    function resetToStart(){
      // return to start node (no lives reset)
      renderNode('start');
    }

    // full reset of game (lives reset)
    function resetGameFull(){
      state.lives = 2;
      updateLives();
      // reset background and confetti
      giftBg.classList.remove('reveal');
      stopConfetti();
      // restart mystery music
      try { AUDIO.success.pause(); AUDIO.success.currentTime = 0; } catch(e){}
      try { AUDIO.mystery.currentTime = 0; /* will play when user clicks next */ } catch(e){}
      state.startedSound = false;
      renderNode('start');
    }

    // modal helpers
    function showModal(title, msg, onRetry){
      modalTitle.textContent = title;
      modalMsg.textContent = msg;
      modal.classList.add('show');
      modalRetry.onclick = () => { if(onRetry) onRetry(); };
    }
    function closeModal(){ modal.classList.remove('show'); }

    modalRetry.addEventListener('click', closeModal);

    /***************************
     * Confetti (simple canvas)
     ***************************/
    let confettiInterval = null;
    const confettiPieces = [];
    function startConfetti(){
      const canvas = confCanvas;
      const ctx = canvas.getContext('2d');
      function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
      resize();
      window.addEventListener('resize', resize);
      // generate pieces
      confettiPieces.length = 0;
      const colors = ['#f59e0b','#f97316','#fb923c','#fde68a','#ffffff'];
      for(let i=0;i<140;i++){
        confettiPieces.push({ x: Math.random()*canvas.width, y: Math.random()*-canvas.height, vy:2+Math.random()*4, angle:Math.random()*360, r:2+Math.random()*7, c: colors[Math.floor(Math.random()*colors.length)] });
      }
      let t = 0;
      function frame(){
        t++;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        confettiPieces.forEach(p=>{
          p.x += Math.sin((p.y + t)/20)*1.5;
          p.y += p.vy;
          ctx.fillStyle = p.c;
          ctx.save();
          ctx.translate(p.x,p.y);
          ctx.rotate((p.angle + t/3)*Math.PI/180);
          ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r*1.6);
          ctx.restore();
          if(p.y > canvas.height + 20){ p.y = -20; p.x = Math.random()*canvas.width; }
        });
        confettiInterval = requestAnimationFrame(frame);
      }
      confettiInterval = requestAnimationFrame(frame);
    }
    function stopConfetti(){
      if(confettiInterval) cancelAnimationFrame(confettiInterval);
      const ctx = confCanvas.getContext('2d');
      ctx.clearRect(0,0,confCanvas.width,confCanvas.height);
    }

    /***************************
     * Initialization
     ***************************/
    // set name if wanted (keeps "Mi Esposita" by default)
    document.getElementById('name').textContent = 'Mi Esposita';

    updateLives();
    renderNode('start');

    // Accessibility: allow numeric keys 1/2 to pick first/second option
    document.addEventListener('keydown', (e) => {
      const opts = Array.from(optionsEl.querySelectorAll('.opt'));
      if(opts.length && (e.key === '1' || e.key === '2')){
        const idx = e.key === '1' ? 0 : 1;
        const btn = opts[idx];
        if(btn) btn.click();
      }
    });

    // When modal is open, clicking outside should close? keep simple: only retry button closes
  </script>
</body>
</html>
