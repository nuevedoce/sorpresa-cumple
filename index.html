<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Misi√≥n Cumplea√±os: N¬∫34</title>
  <style>
.hidden {
  display: none;
}
    :root{--card-bg: rgba(0,0,0,0.66);--muted:#cbd5e1;--accent:#e11d48}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family: 'Courier New', Courier, monospace;background:#111827;color:#e6eef8}
    .stage{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;position:relative;overflow:hidden}
    #gift-bg{position:fixed;inset:0;background-size:cover;background-position:center;filter:blur(25px);transition:filter 5s ease-out,opacity 1s ease-in;opacity:0;z-index:1;background-color:#111}
    #gift-bg.reveal{filter:blur(0);opacity:1}
    .card{width:100%;max-width:780px;padding:22px;border-radius:14px;background:linear-gradient(180deg, rgba(20,20,30,0.8), rgba(10,10,20,0.9));box-shadow:0 10px 40px rgba(2,6,23,0.7);position:relative;z-index:2; border: 1px solid rgba(255,255,255,0.1);}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    header h1{font-size:20px;margin:0; color: var(--accent);}
    .lives{font-size:18px}
    #image-container{text-align: left; margin-bottom: 16px; min-height: 150px;}
    #image-container img{max-width:80%; max-height: 250px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5);}
    .story{margin-top:18px;font-size:16px;line-height:1.5;color:#e6eef8}
    .options{display:flex;flex-direction:column;gap:12px;margin-top:18px}
    .opt{background:transparent;border:2px solid rgba(255,255,255,0.1);padding:12px 14px;border-radius:10px;text-align:left;color:#e6eef8;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:10px;transition: all .2s}
    .opt:hover{transform:translateY(-3px);border-color:var(--accent); background-color: rgba(225, 29, 72, 0.1);}
    .modal{position:fixed;left:65%;top:45%;transform:translate(-50%, -50%);min-width:260px;max-width:90%;background:rgba(2,6,23,0.95);border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(2,6,23,0.8);z-index:999;display:none; border: 1px solid rgba(255,255,255,0.1);}
    .modal.show{display:block}
    .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--accent);color:#fff}
    canvas.confetti{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:999}
    .final-title{font-size:24px;margin:8px 0; color: var(--accent);}
  </style>
</head>
<body>
  <div id="splash-screen" class="stage" style="position: fixed; inset: 0; background: #111827; z-index: 1000; transition: opacity 0.5s ease-out;">
  <div class="card" style="text-align: center;">
    <h1 style="color: var(--accent); font-size: 24px;">MISI√ìN: 03/10/2025</h1>
    <p style="font-size: 18px; margin-top: 10px;">Tu aventura est√° a punto de comenzar...</p>
    <button id="start-button" class="btn primary" style="margin-top: 20px; font-size: 18px; padding: 12px 24px; cursor: pointer;">Comenzar Misi√≥n</button>
  </div>
</div>
  <div id="gift-bg" aria-hidden="true"></div>

  <main class="stage hidden" role="main">
    <section class="card" aria-live="polite">
      <header>
        <div>
          <h1 id="main-title">MISI√ìN: 03/10/2025</h1>
          <p class="small" style="color: var(--muted);">Agente, su objetivo le espera. Act√∫e con sigilo.</p>
        </div>
        <div class="lives">Intentos: <span id="hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
      </header>

      <div id="image-container"></div>
      <article class="story" id="story">Iniciando sistema...</article>
      <div class="options" id="options" role="list"></div>
      <div class="footer" style="margin-top:18px;color:#cbd5e1;font-size:13px; text-align: center;">Este mensaje se autodestruir√°... eventualmente. üòâ</div>
    </section>
  </main>

  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <h3 id="modal-title">-- MISI√ìN COMPROMETIDA --</h3>
    <p id="modal-msg">Mensaje</p>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button id="modal-retry" class="btn primary">Reintentar Misi√≥n</button>
    </div>
  </div>
  
  <canvas id="cconf" class="confetti" aria-hidden="true"></canvas>

  <script>
    // ---------- CONFIGURACI√ìN PRINCIPAL ----------
    const AGENT_NAME = 'Sof√≠a';
    const GIFT_IMAGE_URL = './img/egipto-atardecer.jpg';

    // ---------- RECURSOS LOCALES (Sonidos) ----------
    const AUDIO = {
  mystery: new Audio('./audio/mystery.mp3'),
  fail: new Audio('./audio/fail.mp3'),
  correct: new Audio('./audio/correct.mp3'), // Antes 'success'
  egypt: new Audio('./audio/egypt.mp3')      // Nuevo sonido final
};
    AUDIO.mystery.loop = true;
    
    // ---------- NODOS DE LA AVENTURA PERSONALIZADA ----------
    const NODES = {
      start: {
        text: `Feliz cumplea√±os!, mi agente favorita. Hoy, tu misi√≥n es descifrar una serie de pistas para encontrar tu verdadera sorpresa. Pero cuidado, el camino est√° lleno de tentaciones encantadoras. ¬øLista para empezar, ${AGENT_NAME}?`,
        image: './img/agente-portada.gif',
        options: [
          {emoji:'üòé',text:'Misi√≥n aceptada',next:'node1'},
          {emoji:'ü§®',text:'¬øDe qu√© va todo esto?',next:'node1'}
        ]
      },
      node1: {
        text: `Excelente. Tu primera pista te lleva a una encrucijada de bienestar. Debes elegir una experiencia para "despejar la mente" antes del verdadero desaf√≠o. ¬øQu√© decides?`,
        image: './img/spa.jpg',
        options: [
          {emoji:'üíÜ',text:'Masajes relajantes',next:'fail_masaje'},
          {emoji:'‚úàÔ∏è',text:'Una experiencia de alto vuelo',next:'node2'}
        ]
      },
      fail_masaje: { text:`Los masajes fueron tan incre√≠blemente relajantes que te quedaste dormida. So√±aste con la misi√≥n, pero al despertar, las pistas se hab√≠an enfriado. ¬°Misi√≥n comprometida!`, image: './img/siesta.gif', fail: true },
      node2: {
        text: `¬°Adrenalina pura! Te entregan un malet√≠n con gadgets de √∫ltima generaci√≥n. "Elige tu herramienta, agente". El contenido del malet√≠n determinar√° tu pr√≥ximo movimiento.`,
        image: './img/gadgets.jpg',
        options: [
          {emoji:'üé§',text:'Micr√≥fono y estabilizador',next:'fail_contenido'},
          {emoji:'üó∫Ô∏è',text:'Un proyector de mapas',next:'node3'}
        ]
      },
      fail_contenido: { text:`El equipo era tan bueno que empezaste a crear contenido ah√≠ mismo. Tu video "Unboxing de gadgets secretos" se hizo viral, pero revel√≥ tu posici√≥n al enemigo. ¬°Misi√≥n comprometida!`, image: './img/youtuber-fail.gif', fail: true },
      node3: {
        text: `El proyector muestra el camino hacia un bazar misterioso. "Elige entre el aroma del desierto o la emoci√≥n del cielo", te susurra una voz al o√≠do. Dos objetos brillan sobre el mostrador: un frasco ex√≥tico y un ticket dorado.`,
        image: './img/bazar.jpg',
        options: [
          {emoji:'üß¥',text:'Un perfume √°rabe',next:'fail_perfume'},
          {emoji:'ü™Ç',text:'Un ticket para saltar en paraca√≠das',next:'fail_paracaidas'}
        ]
      },
      fail_perfume: { text:`El perfume era tan magn√©tico que un encantador de serpientes te confundi√≥ con su musa y no te dej√≥ marchar hasta que le ense√±aste tus trucos. Perdiste un tiempo valioso. ¬°Misi√≥n comprometida!`, image: './img/serpiente.gif', fail: true },
      fail_paracaidas: { text:`El salto fue incre√≠ble, pero aterrizaste en medio de un festival de m√∫sica beduina. Te coronaron reina del baile y la fiesta dur√≥ horas. Divertido, pero... ¬°Misi√≥n comprometida!`, image: './img/paracaidas-fallo.gif', fail: true },
      node_secret_choice: {
        text: `Un momento... mientras te distra√≠as con los objetos, una nota cay√≥ de tu bolsillo. Es un trozo de mapa antiguo. El proyector reacciona y revela un nuevo camino. Un √∫nico destino. El destino que siempre has visualizado.`,
        image: './img/mapa-secreto.gif',
        options: [ {emoji:'‚ú®',text:'Seguir el mapa del destino', next:'success'} ]
      },
      success:{ text:`¬°MISI√ìN CUMPLIDA, ${AGENT_NAME.toUpperCase()}! \n\nEl verdadero tesoro no era un objeto, sino un sue√±o. Es hora de sacar esa imagen de tu vision board y hacerla realidad. Mi amor, ¬°nos vamos a Egipto!`, success:true }
    };

    // ---------- L√ìGICA DEL JUEGO ----------
    let state = {current:'start',lives:3,startedSound:false};
    const storyEl = document.getElementById('story'), optionsEl = document.getElementById('options'), heartsEl = document.getElementById('hearts'), imageContainerEl = document.getElementById('image-container');
    const giftBg = document.getElementById('gift-bg'), modal = document.getElementById('modal'), modalTitle = document.getElementById('modal-title'), modalMsg = document.getElementById('modal-msg'), modalRetry = document.getElementById('modal-retry');
    const confCanvas = document.getElementById('cconf');

    function renderNode(key){
      state.current = key;
      const node = NODES[key];
      imageContainerEl.innerHTML = node.image ? `<img src="${node.image}" alt="Escena de la aventura">` : '';
      storyEl.textContent = node.text;
      optionsEl.innerHTML = '';
      if(node.options && node.options.length){
        node.options.forEach(opt => {
          const b=document.createElement('button'); b.className='opt'; b.innerHTML=`<span class="emoji">${opt.emoji}</span><span>${opt.text}</span>`;
          b.addEventListener('click', ()=> onChoose(opt)); optionsEl.appendChild(b);
        });
      } else {
        if(node.fail) handleFail(node); else if(node.success) handleSuccess(node);
      }
    }

    function onChoose(opt){
  if(!state.startedSound){
    try{ AUDIO.mystery.play().catch(()=>{}); }catch(e){}
    state.startedSound = true;
  }
  const targetNode = NODES[opt.next];

  // A√ëADIMOS ESTA L√ìGICA
  // Si el pr√≥ximo paso NO es un fallo, es un acierto
  if (!targetNode.fail) {
    try { AUDIO.correct.currentTime = 0; AUDIO.correct.play().catch(()=>{}); } catch(e){}
  }

 if(state.current === 'node3' && (opt.next === 'fail_perfume' || opt.next === 'fail_paracaidas')) {
      renderNode(opt.next);      // <-- A√ëADIDO: Muestra la escena del fallo.
      handleFail(targetNode, true); // Muestra el modal encima.
  } else if (targetNode) {
      renderNode(opt.next);
  }
}

    function handleFail(node, isSoftFail = false){
      try{ AUDIO.fail.currentTime = 0; AUDIO.fail.play().catch(()=>{});}catch(e){}
      state.lives = Math.max(0, state.lives - 1); updateLives();
      const msg = (state.lives > 0 ? `Te quedan ${state.lives} intento(s).` : `No te quedan m√°s intentos.`);
      const onRetry = () => {
        closeModal();
        if (isSoftFail && state.lives > 0) { renderNode('node_secret_choice'); }
        else if(state.lives > 0) { resetToStart(); }
        else { resetGameFull(); }
      };
      showModal('-- MISI√ìN COMPROMETIDA --', msg, onRetry);
    }

    function handleSuccess(node){
      try { AUDIO.mystery.pause(); } catch(e){}
      try { AUDIO.egypt.currentTime = 0; AUDIO.egypt.play().catch(()=>{}); } catch(e){}
      storyEl.innerHTML = `<div class="final-title">¬°PAQUETE RECUPERADO!</div><div style="white-space:pre-line">${node.text}</div>`;
      optionsEl.innerHTML = '';
      giftBg.style.backgroundImage = `url('${GIFT_IMAGE_URL}')`;
      setTimeout(()=> { giftBg.classList.add('reveal'); startConfetti(); }, 120);
      const btn = document.createElement('button'); btn.className='opt'; btn.innerHTML=`<span class="emoji">üîÅ</span><span>Jugar de nuevo</span>`;
      btn.addEventListener('click', ()=> { stopConfetti(); resetGameFull(); });
      optionsEl.appendChild(btn);
    }

    function updateLives(){ heartsEl.textContent = '‚ù§Ô∏è'.repeat(state.lives) + (state.lives>0 ? 'ü§ç'.repeat(3-state.lives) : ''); }
    function resetToStart(){ renderNode('start'); }
    function resetGameFull(){
      state.lives = 3;
      updateLives();
      giftBg.classList.remove('reveal');
      stopConfetti();
      try { AUDIO.mystery.currentTime = 0; } catch(e) {}
      try { AUDIO.success.pause(); AUDIO.success.currentTime = 0; } catch(e) {}
      state.startedSound = false;
      renderNode('start');
    }

    function showModal(title,msg,onRetry){ modalTitle.textContent=title; modalMsg.textContent=msg; modal.classList.add('show'); modalRetry.onclick = ()=> onRetry(); }
    function closeModal(){ modal.classList.remove('show'); }

    // Confetti
    let confettiRAF = null; const confettiPieces=[];
    function startConfetti(){
      const canvas=confCanvas, ctx=canvas.getContext('2d');
      function resize(){canvas.width=window.innerWidth;canvas.height=window.innerHeight}
      resize(); window.addEventListener('resize',resize);
      confettiPieces.length=0;
      const colors=['#f59e0b','#f97316','#e11d48','#fde68a','#fff'];
      for(let i=0;i<140;i++) confettiPieces.push({x:Math.random()*canvas.width,y:Math.random()*-canvas.height,vy:2+Math.random()*4,angle:Math.random()*360,r:2+Math.random()*7,c:colors[Math.floor(Math.random()*colors.length)]});
      let t=0;
      function frame(){
        t++; ctx.clearRect(0,0,canvas.width,canvas.height);
        confettiPieces.forEach(p=>{
          p.x+=Math.sin((p.y+t)/20)*1.5; p.y+=p.vy;
          ctx.fillStyle=p.c; ctx.save(); ctx.translate(p.x,p.y);
          ctx.rotate((p.angle+t/3)*Math.PI/180);
          ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r*1.6); ctx.restore();
          if(p.y>canvas.height+20){p.y=-20;p.x=Math.random()*canvas.width}
        });
        confettiRAF = requestAnimationFrame(frame);
      }
      confettiRAF = requestAnimationFrame(frame);
    }
    function stopConfetti(){
      if(confettiRAF) cancelAnimationFrame(confettiRAF);
      const ctx=confCanvas.getContext('2d');
      ctx.clearRect(0,0,confCanvas.width,confCanvas.height);
    }

    // Init
document.getElementById('main-title').textContent = `MISI√ìN: CUMPLEA√ëOS ${AGENT_NAME.toUpperCase()}`;
updateLives();

const startButton = document.getElementById('start-button');
const splashScreen = document.getElementById('splash-screen');
const mainContent = document.querySelector('main.stage');

startButton.addEventListener('click', () => {
  // 1. Iniciar la m√∫sica (ahora s√≠ est√° permitido por el clic)
  try {
    AUDIO.mystery.play().catch(()=>{});
  } catch(e) {}
  state.startedSound = true;

  // 2. Ocultar la pantalla de inicio con una transici√≥n
  splashScreen.style.opacity = '0';
  setTimeout(() => {
    splashScreen.style.display = 'none';
  }, 500); // 500ms, igual que la transici√≥n en el CSS

  // 3. Mostrar el contenido principal y empezar la aventura
  mainContent.classList.remove('hidden');
  mainContent.style.display = 'flex'; // Aseguramos que se muestre como flex
  renderNode('start');
});

document.addEventListener('keydown',(e)=>{ const opts = Array.from(optionsEl.querySelectorAll('.opt')); if(opts.length && (e.key==='1' || e.key==='2')){ const idx = e.key==='1' ? 0 : 1; const btn = opts[idx]; if(btn) btn.click(); }});
  </script>
</body>
</html>









